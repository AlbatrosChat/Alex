<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEX</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/zW2390sJ/IMG-20260127-113253.jpg">
    <link rel="apple-touch-icon" href="https://i.ibb.co/zW2390sJ/IMG-20260127-113253.jpg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --navy: #0f172a; --emerald: #10b981; --slate: #f1f5f9; --danger: #ef4444; --warning: #f59e0b; --indigo: #6366f1; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--slate); color: #1e293b; }
        
        /* شاشة تسجيل الدخول المحدثة */
        #loginScreen { position: fixed; inset: 0; background: #000000; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: #111; padding: 40px; border-radius: 24px; width: 350px; text-align: center; box-shadow: 0 0 25px rgba(16, 185, 129, 0.15); border: 1px solid #222; }
        .login-card h2 { color: white; margin-top: 10px; }
        .login-card input { background: #1a1a1a; border: 1px solid var(--emerald); color: white; margin-bottom: 15px; text-align: center; }
        .login-card input::placeholder { color: #555; }
        
        /* الدائرة حول اللوجو */
        .login-logo-container { 
            width: 120px; height: 120px; 
            margin: 0 auto 15px; 
            border-radius: 50%; 
            border: 3px solid var(--emerald); 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #fff;
            box-shadow: 0 0 15px var(--emerald);
        }
        .login-logo-container img { width: 75%; height: 70%; object-fit: cover; }

        header { background: var(--navy); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--emerald); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dropdown { position: relative; }
        .drop-content { display: none; position: absolute; right: 0; background: white; min-width: 250px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-radius: 12px; z-index: 2000; overflow: hidden; border: 1px solid #e2e8f0; }
        .drop-content button { width: 100%; padding: 14px; border: none; background: none; text-align: right; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .drop-content button:hover { background: #f8fafc; color: var(--indigo); padding-right: 20px; }
        .show { display: block !important; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 40px; border: 1px solid rgba(0,0,0,0.05); }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input, select, textarea { padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; width: 100%; box-sizing: border-box; outline: none; transition: 0.3s; font-size: 1rem; }
        .btn-main { background: var(--emerald); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1rem; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main:hover { opacity: 0.9; transform: translateY(0px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 700px; }
        th { background: #f8fafc; padding: 15px; text-align: right; color: #64748b; font-size: 0.85rem; }
        td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .action-icon { font-size: 0.9rem; padding: 8px; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-edit { background: #fef3c7; color: var(--warning); }
        .btn-del { background: #fee2e2; color: var(--danger); }
        .badge-user { background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .hidden { display: none !important; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10000; border: 2px solid var(--emerald); display: none; font-weight: bold; }
        #msgModal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 11000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 450px; width: 90%; text-align: center; border-top: 6px solid var(--indigo); }
        .total-box { display: flex; justify-content: space-around; background: linear-gradient(135deg, var(--navy), #1e293b); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .total-val { font-size: 1.5rem; font-weight: bold; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div id="toast">✅ تم تسجيل الدخول بنجاح</div>

<div id="msgModal">
    <div class="modal-content">
        <i class="fas fa-envelope-open-text" style="font-size: 3.5rem; color: var(--indigo); margin-bottom: 20px;"></i>
        <h2 style="margin:0">رسالة هامة من الإدارة</h2>
        <p id="msgBody" style="line-height: 1.8; color: #475569; margin: 20px 0; font-size: 1.1rem; white-space: pre-wrap;"></p>
        <button class="btn-main" onclick="ui.closeMsg()" style="background: var(--navy);">لقد قرأت الرسالة</button>
    </div>
</div>

<div id="loginScreen">
    <div class="login-card">
        <div class="login-logo-container">
            <img src="https://i.ibb.co/jP1Cx3fP/1769455758378.png" alt="Logo">
        </div>
        <h2>أهلاً بك مجدداً</h2>
        <p style="color:#64748b; font-size: 0.95rem; margin-bottom: 25px;">نظام ALEX لإدارة الحسابات</p>
        
        <input type="text" id="uIn" value="Ali" placeholder="اسم المستخدم">
        <input type="password" id="pIn" placeholder="كلمة المرور">
        
        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; cursor: pointer; color: #8892b0; font-size: 0.9rem;">
            <input type="checkbox" id="rememberMe" style="width: 18px; height: 18px;"> تذكر دخولي
        </label>
        
        <button class="btn-main" style="background: var(--emerald); height: 50px;" onclick="auth.login()">دخول للنظام</button>
    </div>
</div>

<div id="app" class="hidden">
    <header>
        <div class="dropdown">
            <button onclick="ui.toggle()" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-bars"></i> القائمة الرئيسية
            </button>
            <div id="dropMenu" class="drop-content">
                <button onclick="ui.view('entry')"><i class="fas fa-file-invoice-dollar" style="color:var(--emerald)"></i> تسجيل عملية جديدة</button>
                <button onclick="ui.view('monthly')"><i class="fas fa-chart-line" style="color:var(--indigo)"></i> الجرد والتقارير</button>
                <div id="ownerOnly" class="hidden" style="border-top: 2px solid #f1f5f9;">
                    <button onclick="ui.view('staff')"><i class="fas fa-users-cog" style="color:var(--warning)"></i> إعدادات الموظفين والرسائل</button>
                </div>
                <button onclick="admin.export()" style="background:#f0fdf4"><i class="fas fa-file-excel" style="color:#16a34a"></i> تصدير البيانات Excel</button>
                <button onclick="auth.logout()" style="color:var(--danger); border-top: 1px solid #eee;"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 30px;">
            <span id="activeUser" style="font-weight: 600;"></span>
            <i class="fas fa-user-circle fa-lg"></i>
        </div>
    </header>

    <div class="container">
        <div id="sectionStaff" class="card hidden">
            <h3><i class="fas fa-user-plus"></i> إضافة موظف ورسالة</h3>
            <div class="input-grid">
                <input type="text" id="newStaffU" placeholder="اسم المستخدم">
                <input type="text" id="newStaffP" placeholder="كلمة المرور">
            </div>
            <textarea id="newStaffMsg" placeholder="اكتب رسالة تظهر للموظف عند دخوله..." style="height: 80px; margin-bottom: 15px;"></textarea>
            <button class="btn-main" onclick="admin.addStaff()" style="background:var(--indigo)">اعتماد الحساب</button>
            <div id="staffListArea" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px; margin-top: 20px;"></div>
        </div>

        <div id="sectionEntry" class="card">
            <h3 style="margin-top:0">إضافة حركة مالية</h3>
            <div class="input-grid">
                <input type="text" id="inSyp" placeholder="المبلغ (SYP)" oninput="ui.format(this)">
                <input type="text" id="inUsd" placeholder="المبلغ (USD)" oninput="ui.format(this)">
                <input type="text" id="inNote" placeholder="بيان العملية / ملاحظات...">
            </div>
            <button class="btn-main" id="saveBtn" onclick="core.save()"><i class="fas fa-check-circle"></i> حفظ العملية</button>
        </div>

        <div id="sectionMonthly" class="card hidden">
            <h3><i class="fas fa-search"></i> بحث في الأرشيف</h3>
            <div class="input-grid" style="grid-template-columns: 2fr 2fr 1fr;">
                <select id="filterMonth">
                    <option value="1">يناير</option><option value="2">فبراير</option><option value="3">مارس</option>
                    <option value="4">أبريل</option><option value="5">مايو</option><option value="6">يونيو</option>
                    <option value="7">يوليو</option><option value="8">أغسطس</option><option value="9">سبتمبر</option>
                    <option value="10">أكتوبر</option><option value="11">نوفمبر</option><option value="12">ديسمبر</option>
                </select>
                <input type="number" id="filterYear" value="2026">
                <button class="btn-main" onclick="core.render()" style="background:var(--navy)">تحديث العرض</button>
            </div>
        </div>

        <div class="total-box">
            <div style="text-align: center;">إجمالي اليوم سوري <span class="total-val" id="totalSyp" style="color:var(--emerald)">0</span></div>
            <div style="text-align: center;">إجمالي اليوم دولار <span class="total-val" id="totalUsd" style="color: #60a5fa;">0</span></div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div style="padding:15px 20px; font-weight: bold; background: #fcfcfc; border-bottom: 1px solid #eee;" id="tableTitle">سجل العمليات</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الوقت</th>
                            <th>بواسطة</th>
                            <th>سوري (SYP)</th>
                            <th>دولار (USD)</th>
                            <th>الملاحظات</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// الكود البرمجي المكتمل
let CUR_USER = "";
let VIEWING_USER = "";
let EDIT_ID = null;
const MASTER = "Ali";

const db = {
    tx: () => JSON.parse(localStorage.getItem('alex_db_v10') || '[]'),
    save: (d) => localStorage.setItem('alex_db_v10', JSON.stringify(d)),
    users: () => JSON.parse(localStorage.getItem('alex_users_v10') || `[{"u":"Ali","p":"8899","msg":""}]`),
    saveUsers: (u) => localStorage.setItem('alex_users_v10', JSON.stringify(u)),
    setSession: (u) => localStorage.setItem('alex_session_v10', u),
    getSession: () => localStorage.getItem('alex_session_v10'),
    clearSession: () => localStorage.removeItem('alex_session_v10')
};

const auth = {
    login: () => {
        const u = document.getElementById('uIn').value.trim();
        const p = document.getElementById('pIn').value;
        const remember = document.getElementById('rememberMe').checked;
        const user = db.users().find(x => x.u === u && x.p === p);
        if(user) {
            CUR_USER = u; VIEWING_USER = u;
            if(remember) db.setSession(u);
            document.getElementById('toast').style.display = 'block';
            setTimeout(() => { document.getElementById('toast').style.display = 'none'; auth.initApp(user); }, 1000);
        } else alert("❌ بيانات غير صحيحة");
    },
    initApp: (user) => {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('activeUser').innerText = CUR_USER === MASTER ? "المدير: Ali" : `الموظف: ${CUR_USER}`;
        if(CUR_USER === MASTER) document.getElementById('ownerOnly').classList.remove('hidden');
        if(user.msg) { document.getElementById('msgBody').innerText = user.msg; document.getElementById('msgModal').style.display = 'flex'; }
        core.render();
    },
    logout: () => { db.clearSession(); location.reload(); }
};

const core = {
    save: () => {
        const syp = document.getElementById('inSyp').value.replace(/,/g, '');
        const usd = document.getElementById('inUsd').value.replace(/,/g, '');
        const note = document.getElementById('inNote').value;
        if(!syp && !usd) return alert("أدخل مبلغاً أولاً");

        let all = db.tx();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-CA');

        if(EDIT_ID) {
            all = all.map(x => x.id === EDIT_ID ? {...x, syp:+syp, usd:+usd, note} : x);
            EDIT_ID = null;
        } else {
            all.push({
                id: Date.now(), user: CUR_USER, syp: +syp, usd: +usd, note,
                ts: now.toISOString(),
                date: dateStr,
                month: now.getMonth() + 1, year: now.getFullYear()
            });
        }
        db.save(all);
        ui.reset(); core.render();
    },
    render: () => {
        const body = document.getElementById('tableBody');
        const fMonth = parseInt(document.getElementById('filterMonth').value);
        const fYear = parseInt(document.getElementById('filterYear').value);
        const todayStr = new Date().toLocaleDateString('en-CA');
        
        let filtered = db.tx().filter(x => x.user === VIEWING_USER && x.month === fMonth && x.year === fYear);
        let sSyp = 0, sUsd = 0;
        body.innerHTML = "";
        
        filtered.reverse().forEach(x => {
            if(x.date === todayStr) { sSyp += x.syp; sUsd += x.usd; }
            body.innerHTML += `
                <tr>
                    <td><span style="color:#64748b">${x.date || '---'}</span></td>
                    <td>${new Date(x.ts).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td><span class="badge-user">${x.user}</span></td>
                    <td style="color:var(--emerald); font-weight:bold;">${x.syp.toLocaleString()}</td>
                    <td style="color:var(--indigo); font-weight:bold;">${x.usd.toLocaleString()}</td>
                    <td>${x.note}</td>
                    <td>
                        <button class="action-icon btn-edit" onclick="core.edit(${x.id})"><i class="fas fa-pen"></i></button>
                        <button class="action-icon btn-del" onclick="core.del(${x.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
        document.getElementById('totalSyp').innerText = sSyp.toLocaleString();
        document.getElementById('totalUsd').innerText = sUsd.toLocaleString();
    },
    edit: (id) => {
        const item = db.tx().find(x => x.id === id);
        EDIT_ID = id;
        document.getElementById('inSyp').value = item.syp.toLocaleString();
        document.getElementById('inUsd').value = item.usd.toLocaleString();
        document.getElementById('inNote').value = item.note;
        document.getElementById('saveBtn').innerHTML = "<i class='fas fa-sync'></i> تحديث الحركة";
        ui.view('entry');
    },
    del: (id) => { if(confirm("حذف العملية؟")) { db.save(db.tx().filter(x => x.id !== id)); core.render(); } }
};

const admin = {
    addStaff: () => {
        const u = document.getElementById('newStaffU').value.trim();
        const p = document.getElementById('newStaffP').value.trim();
        const msg = document.getElementById('newStaffMsg').value.trim();
        if(!u || !p) return alert("أكمل البيانات");
        let users = db.users();
        if(users.some(x => x.u === u)) return alert("المستخدم موجود");
        users.push({u, p, msg});
        db.saveUsers(users);
        ui.reset(); admin.renderStaffList();
        alert("تمت الإضافة");
    },
    renderStaffList: () => {
        const area = document.getElementById('staffListArea');
        area.innerHTML = "";
        db.users().forEach(user => {
            if(user.u === MASTER) return;
            area.innerHTML += `
                <div class="card" style="border: 1px solid #ddd; margin-bottom:0;">
                    <div style="font-weight: bold;">${user.u}</div>
                    <div style="display:flex; gap: 8px; margin-top:10px;">
                        <button class="btn-main" onclick="admin.viewStaffDb('${user.u}')" style="font-size: 0.8rem; background:var(--indigo);">الجرد</button>
                        <button class="btn-main" onclick="admin.delStaff('${user.u}')" style="font-size: 0.8rem; background: var(--danger);">حذف</button>
                    </div>
                </div>`;
        });
    },
    viewStaffDb: (user) => { VIEWING_USER = user; core.render(); },
    delStaff: (user) => { if(confirm(`حذف ${user}؟`)) { db.saveUsers(db.users().filter(x => x.u !== user)); admin.renderStaffList(); } },
    export: () => {
        const data = db.tx();
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `Report_ALEX.xlsx`);
    }
};

const ui = {
    toggle: () => document.getElementById('dropMenu').classList.toggle('show'),
    view: (v) => {
        document.getElementById('sectionEntry').classList.toggle('hidden', v !== 'entry');
        document.getElementById('sectionMonthly').classList.toggle('hidden', v !== 'monthly');
        document.getElementById('sectionStaff').classList.toggle('hidden', v !== 'staff');
        if(v === 'staff') admin.renderStaffList();
        document.getElementById('dropMenu').classList.remove('show');
    },
    format: (i) => {
        let v = i.value.replace(/\D/g, "");
        i.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    closeMsg: () => document.getElementById('msgModal').style.display = 'none',
    reset: () => {
        document.getElementById('inSyp').value = ""; document.getElementById('inUsd').value = "";
        document.getElementById('inNote').value = ""; document.getElementById('newStaffU').value = "";
        document.getElementById('newStaffP').value = ""; document.getElementById('newStaffMsg').value = "";
        document.getElementById('saveBtn').innerHTML = "<i class='fas fa-check-circle'></i> حفظ العملية";
        EDIT_ID = null;
    }
};

window.onload = () => {
    const saved = db.getSession();
    if(saved) {
        const user = db.users().find(x => x.u === saved);
        if(user) { CUR_USER = saved; VIEWING_USER = saved; auth.initApp(user); }
    }
    const d = new Date();
    document.getElementById('filterMonth').value = d.getMonth() + 1;
    document.getElementById('filterYear').value = d.getFullYear();
};

window.onclick = (e) => { 
    if (!e.target.closest('.dropdown')) {
        document.getElementById('dropMenu').classList.remove('show');
    }
};
</script>

</body>
</html>
